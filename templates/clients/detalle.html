{% extends "base.html" %}
{% block title %}{{ cliente.nombre_completo }} · Cliente{% endblock %}

{% block content %}

<!-- Encabezado -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h4 class="mb-1">{{ cliente.nombre_completo }}</h4>
    <div class="text-muted">
      <i class="bi bi-person-badge me-1"></i> RUT: {{ cliente.rut }}
      {% if cliente.es_sensible %}
        <span class="badge text-bg-warning ms-2">Datos sensibles</span>
      {% endif %}
    </div>
  </div>
  <div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" href="{% url 'clients:listar' %}">
      <i class="bi bi-arrow-left"></i> Volver
    </a>
    <a class="btn btn-outline-primary" href="{% url 'clients:editar' cliente.pk %}">
      <i class="bi bi-pencil-square"></i> Editar
    </a>
    <a class="btn btn-primary" href="{% url 'cases:crear_caso' %}?cliente={{ cliente.id }}">
      <i class="bi bi-plus-lg"></i> Nuevo caso
    </a>
  </div>
</div>

<!-- Datos del cliente -->
<div class="card mb-4">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-6">
        <div class="text-muted small">Correo</div>
        <div>{{ cliente.correo|default:"—" }}</div>
      </div>
      <div class="col-md-6">
        <div class="text-muted small">Teléfono</div>
        <div>{{ cliente.telefono|default:"—" }}</div>
      </div>
      <div class="col-12">
        <div class="text-muted small">Dirección</div>
        <div>{{ cliente.direccion|linebreaksbr|default:"—" }}</div>
      </div>
      <div class="col-12">
        <div class="text-muted small">Notas</div>
        <div class="text-pre-wrap">{{ cliente.notas|linebreaksbr|default:"—" }}</div>
      </div>
    </div>
  </div>
</div>

<!-- Casos del cliente -->
<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h5 class="mb-0">Casos de {{ cliente.nombre_completo }}</h5>
    </div>

    <div class="table-responsive">
      <table class="table align-middle">
        <thead>
          <tr>
            <th>Código</th>
            <th>Título</th>
            <th>Estado</th>
            <th>Categoría</th>  {# ✅ nueva columna #}
            <th>Abogado responsable</th>
            <th>Creado</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          {% for caso in cliente.casos.all %}
            <tr>
              <td class="fw-medium">{{ caso.codigo_caso }}</td>
              <td>{{ caso.titulo }}</td>

              <!-- Estado -->
              <td>
                {% if caso.estado == "ABIERTO" %}
                  <span class="badge rounded-pill text-bg-secondary">Abierto</span>
                {% elif caso.estado == "EN_PROCESO" %}
                  <span class="badge rounded-pill text-bg-primary">En proceso</span>
                {% elif caso.estado == "CERRADO" %}
                  <span class="badge rounded-pill text-bg-success">Cerrado</span>
                {% else %}
                  <span class="badge rounded-pill text-bg-light text-dark">{{ caso.estado }}</span>
                {% endif %}
              </td>

              <!-- Categoría -->
              <td>
                {% with cat=caso.categoria %}
                  {% if cat == "HERENCIA" %}
                    <span class="badge text-bg-info">Herencia</span>
                  {% elif cat == "DEMANDA_CIVIL" %}
                    <span class="badge text-bg-danger">Demanda civil</span>
                  {% elif cat == "JUICIO_LABORAL" %}
                    <span class="badge text-bg-warning text-dark">Juicio laboral</span>
                  {% elif cat == "CONTRATO" %}
                    <span class="badge text-bg-primary">Contrato</span>
                  {% elif cat == "ASESORIA" %}
                    <span class="badge text-bg-success">Asesoría</span>
                  {% else %}
                    <span class="badge text-bg-secondary">Otros</span>
                  {% endif %}
                {% endwith %}
              </td>
              <td>
                {% if caso.abogado_responsable %}
                  {% firstof caso.abogado_responsable.get_full_name caso.abogado_responsable.username %}
                {% else %} — {% endif %}
              </td>
              <td>{{ caso.creado_en|date:"M d, Y" }}</td>

              <td class="text-end">
                <a class="btn btn-sm btn-outline-primary"
                  href="{% url 'cases:archivos_caso' caso.id %}" title="Ver archivos del caso">
                  <i class="bi bi-folder2-open"></i> Archivos
                </a>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted py-4">Sin casos registrados</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{% endblock %}
